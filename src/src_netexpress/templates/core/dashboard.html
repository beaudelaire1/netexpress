{% extends "base.html" %}
{% load static %}

{% block title %}Tableau de bord — NetExpress{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
{% endblock %}

{% block content %}
<div class="bo-shell">
  <aside class="bo-sidebar" aria-label="Navigation dashboard">
    <div class="bo-brand">Nettoyage Express</div>
    <nav class="bo-nav">
      <a href="{% url 'admin:index' %}">Accueil admin</a>
      <a class="is-primary" href="{% url 'tasks:calendar' %}">Calendrier des tâches</a>
      <a href="{% url 'tasks:list' %}">Liste des tâches</a>
      <a href="{% url 'factures:archive' %}">Factures</a>
      <a href="{% url 'messaging:compose' %}">Nouveau message</a>
      <a href="{% url 'messaging:list' %}">Historique messages</a>
    </nav>
  </aside>

  <main class="bo-main">
    <div class="bo-head">
      <div>
        <div class="bo-title">Tableau de bord</div>
        <div class="bo-subtitle">Aperçu rapide de l’activité (tâches, factures, messages).</div>
      </div>
    </div>

    <section class="bo-grid" aria-label="Indicateurs clés">
      <article class="bo-card">
        <h3>Tâches</h3>
        <p class="value">{{ tasks|length }}</p>
        <div class="hint">Dernières tâches créées/modifiées.</div>
      </article>
      <article class="bo-card">
        <h3>Factures</h3>
        <p class="value">{{ invoices|length }}</p>
        <div class="hint">Factures récentes (PDF premium).</div>
      </article>
      <article class="bo-card">
        <h3>Messages</h3>
        <p class="value">{{ recent_messages|length }}</p>
        <div class="hint">Historique des e-mails envoyés.</div>
      </article>
    </section>

    <div style="height:18px;"></div>

    <section class="bo-card" style="grid-column: 1 / -1;">
      <h3>Calendrier des tâches</h3>
      <div id="tasks-calendar" style="margin-top:10px;"></div>
      <div class="bo-legend" aria-label="Légende calendrier">
        <span><i class="bo-dot" style="background:#dc2626"></i>En retard</span>
        <span><i class="bo-dot" style="background:#f59e0b"></i>Presque en retard</span>
        <span><i class="bo-dot" style="background:#facc15"></i>Proche</span>
        <span><i class="bo-dot" style="background:#2d8a5e"></i>Dans le timing</span>
        <span><i class="bo-dot" style="background:#2563eb"></i>Terminé</span>
      </div>
    </section>
  </main>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
  (function() {
    const el = document.getElementById('tasks-calendar');
    if (!el || !window.FullCalendar) return;
    const calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      locale: 'fr',
      height: 'auto',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,listWeek'
      },
      events: '{% url "tasks:events" %}',
      eventClick: function(info) {
        if (info.event.url) {
          info.jsEvent.preventDefault();
          window.location.href = info.event.url;
        }
      }
    });
    calendar.render();
  })();
</script>
{% endblock %}
