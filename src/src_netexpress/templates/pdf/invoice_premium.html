{% load static %}
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Facture {{ invoice.number }}</title>
</head>
<body>
  <div class="doc">
    <!-- Barre supérieure avec logo, slogan et informations de facture -->
    <div class="top-bar">
      <div class="logo-block">
        {% if branding.logo_path %}
          <img class="logo" src="file://{{ branding.logo_path }}" alt="Logo">
        {% else %}
          <div class="kicker">{{ branding.name|default:"NetExpress" }}</div>
        {% endif %}
        {% if branding.tagline %}
          <div class="tagline">{{ branding.tagline }}</div>
        {% endif %}
      </div>
      <div class="invoice-info">
        <div class="invoice-number">Facture {{ invoice.number }}</div>
        <div>Date : {{ invoice.issue_date|date:"d/m/Y" }}</div>
        <div>Devis : {% if invoice.quote %}{{ invoice.quote.number }}{% else %}—{% endif %}</div>
        <div>Statut : {{ invoice.get_status_display }}</div>
      </div>
    </div>

    <!-- Encadré mis en avant pour le total TTC -->
    <div class="total-ttc-container">
      <div class="total-ttc-box">
        <div class="total-ttc-label">Total TTC</div>
        <div class="total-ttc-value">{{ invoice.total_ttc|floatformat:2 }} €</div>
      </div>
    </div>

    <!-- Panneaux émetteur et client -->
    <div class="issuer-client">
      <div class="card">
        <div class="card-header">Émetteur</div>
        <div class="card-body">
          <div><strong>{{ branding.name|default:"NetExpress" }}</strong></div>
          <div class="small">
            {% if branding.address_lines %}
              {% for l in branding.address_lines %}{{ l }}<br>{% endfor %}
            {% else %}
              {{ branding.address|linebreaksbr }}
            {% endif %}
          </div>
          <div class="small">
            {% if branding.phone %}{{ branding.phone }}<br>{% endif %}
            {% if branding.email %}{{ branding.email }}{% endif %}
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Client</div>
        <div class="card-body">
          <div><strong>{{ invoice.client_name }}</strong></div>
          <div class="small">
            {% if invoice.client_email %}{{ invoice.client_email }}<br>{% endif %}
            {% if invoice.client_phone %}{{ invoice.client_phone }}<br>{% endif %}
            {% if invoice.client_city %}{{ invoice.client_city }}{% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Tableau des prestations -->
    <table class="table" role="presentation">
      <thead>
        <tr>
          <th>Description</th>
          <th class="right">Quantité</th>
          <th class="right">PU&nbsp;HT</th>
          <th class="right">TVA</th>
          <th class="right">Montant&nbsp;TTC</th>
        </tr>
      </thead>
      <tbody>
      {% for item in invoice.invoice_items.all %}
        <tr>
          <td><strong>{{ item.description }}</strong></td>
          <td class="right">{{ item.quantity }}</td>
          <td class="right">{{ item.unit_price|floatformat:2 }} €</td>
          <td class="right">{{ item.tax_rate|floatformat:2 }} %</td>
          <td class="right">{{ item.total_ttc|floatformat:2 }} €</td>
        </tr>
      {% empty %}
        <tr><td colspan="5" class="small muted">Aucune ligne.</td></tr>
      {% endfor %}
      </tbody>
    </table>

    <!-- Totaux -->
    <div class="totals">
      <div class="totals-box">
        <div class="totals-row"><span class="muted">Total HT</span><span>{{ invoice.total_ht|floatformat:2 }} €</span></div>
        <div class="totals-row"><span class="muted">TVA</span><span>{{ invoice.tva|floatformat:2 }} €</span></div>
        <div class="totals-row total"><strong>Total TTC</strong><strong>{{ invoice.total_ttc|floatformat:2 }} €</strong></div>
      </div>
    </div>

    <!-- Conditions de paiement -->
    <div class="payment">
      <h3>Conditions de paiement</h3>
      <div class="small">
        {{ invoice.payment_terms|default:branding.payment_terms|default:"Paiement : 30 jours après démarrage des travaux." }}
      </div>
    </div>

    <!-- Coordonnées bancaires -->
    <div class="payment" style="border-left-color: var(--brand-2);">
      <div style="display:flex; justify-content:space-between; gap:10mm">
        <div>
          <h3>Règlement</h3>
          <div class="small">Virement bancaire recommandé.</div>
        </div>
        <div style="text-align:right">
          <h3>Coordonnées bancaires</h3>
          <div class="small">
            {% if branding.iban %}<strong>IBAN</strong> : {{ branding.iban }}<br>{% endif %}
            {% if branding.bic %}<strong>BIC</strong> : {{ branding.bic }}{% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Pied de page -->
    <div class="footer">
      <div>Merci pour votre confiance.</div>
      <div style="text-align:right">{{ branding.name|default:"Nettoyage E Express" }}</div>
    </div>
  </div>
</body>
</html>
