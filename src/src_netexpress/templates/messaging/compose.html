{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nouveau message — NetExpress</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/backoffice.css' %}">
  <script src="https://cdn.tiny.cloud/1/6qr0im1d33wizm1ytimh1kpwbugqeb8r4fq1gebb03rme6hv/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body style="margin:0; padding:20px; background:#f9fafb; font-family:'Inter',sans-serif;">

<div class="bo-shell">
  <aside class="bo-sidebar">
    <div class="bo-brand">Nettoyage Express</div>
    <nav class="bo-nav">
      {% if user.is_staff %}
        <a href="{% url 'core:admin_dashboard' %}">Retour dashboard</a>
      {% else %}
        <a href="{% url 'core:client_portal_dashboard' %}">Retour dashboard</a>
      {% endif %}
      <a class="is-primary" href="{% url 'messaging:compose' %}">Nouveau message</a>
      <a href="{% url 'messaging:list' %}">Historique</a>
    </nav>
  </aside>

  <main class="bo-main">
    <div class="bo-head">
      <div>
        <div class="bo-title">Nouveau message</div>
        <div class="bo-subtitle">Rédigez votre message avec mise en forme personnalisée.</div>
      </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="bo-card" style="margin-bottom:14px; padding:12px 16px; {% if message.tags == 'error' %}border-color:rgba(220,38,38,0.3); background:rgba(220,38,38,0.05);{% else %}border-color:rgba(45,138,94,0.3); background:rgba(45,138,94,0.05);{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <section class="bo-card">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="bo-form">
          <label>Sélectionner un client</label>
          <select name="client" id="id_client" style="width:100%; padding:11px 12px; border-radius:14px; border:1px solid var(--bo-border); background:#fff; color:var(--bo-text);">
            <option value="">-- Sélectionner un client --</option>
            {% for client in form.client.field.queryset %}
              <option value="{{ client.pk }}" data-email="{{ client.email }}">{{ client.full_name }} ({{ client.email }})</option>
            {% endfor %}
          </select>

          <div style="text-align:center; color:var(--bo-muted); margin:14px 0; font-size:13px;">— ou —</div>

          <label>Saisir un email manuellement</label>
          <input type="email" name="recipient" id="id_recipient" placeholder="client@example.com">

          <label style="margin-top:14px;">Objet</label>
          <input type="text" name="subject" placeholder="Objet du message" required>

          <label style="margin-top:14px;">Message</label>
          <textarea id="id_content" name="content"></textarea>

          <label style="margin-top:14px;">Pièce jointe (optionnel)</label>
          <input type="file" name="attachment">

          {% if form.errors %}
            <div style="margin-top:14px; padding:12px; border-radius:12px; background:rgba(220,38,38,0.08); border:1px solid rgba(220,38,38,0.2); color:#991b1b; font-size:13px;">
              {% for field, errors in form.errors.items %}
                {% for error in errors %}
                  <div>{{ error }}</div>
                {% endfor %}
              {% endfor %}
            </div>
          {% endif %}

          <div style="margin-top:18px; display:flex; gap:10px;">
            <button class="bo-btn" type="submit">Envoyer</button>
            <a class="bo-btn is-ghost" href="{% url 'messaging:list' %}">Annuler</a>
          </div>
        </div>
      </form>
    </section>
  </main>
</div>

<script>
tinymce.init({
  selector: '#id_content',
  height: 350,
  menubar: false,
  plugins: 'anchor autolink charmap emoticons link lists searchreplace table visualblocks wordcount',
  toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | forecolor backcolor | link table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat',
  content_style: 'body { font-family: Inter, Arial, sans-serif; font-size: 14px; line-height: 1.6; }'
});

document.getElementById('id_client').addEventListener('change', function() {
  const recipientField = document.getElementById('id_recipient');
  if (this.value) {
    recipientField.value = '';
    recipientField.placeholder = 'Email du client sélectionné sera utilisé';
  } else {
    recipientField.placeholder = 'client@example.com';
  }
});
</script>
</body>
</html>
