

partie 1: Audit Technique & Feuille de Route : Nettoyage Express (v2.1)

**Date de l'audit :** 18 D√©cembre 2025
**Version audit√©e :** 2.1
**Statut :** ‚ö†Ô∏è CRITIQUE (S√©curit√©) / En d√©veloppement (Architecture)

Ce document synth√©tise l'analyse technique approfondie du projet NetExpress et d√©finit les directives obligatoires pour la transition vers une architecture ERP robuste et s√©curis√©e.

---

## 1. Analyse Technique Approfondie

### 1.1 üî¥ Audit de S√©curit√© (Priorit√© Absolue)

Une faille critique a √©t√© identifi√©e n√©cessitant une action imm√©diate.

* **Exposition de Secrets (Hardcoded Credentials) :**
    Le fichier de configuration `.env` a √©t√© commit√© et upload√© avec des donn√©es sensibles en clair.
    * **Impact :** Compromission totale possible (acc√®s SMTP Gmail, signature cryptographique Django).
    * **Donn√©es expos√©es :**
        * `EMAIL_HOST_PASSWORD=ymgxtrrstpqwkkwk`
        * `SECRET_KEY=change-me_testing-in-production`
        * Emails administrateurs.
* **Gestion des Droits (RBAC) :**
    Le syst√®me repose actuellement sur des d√©corateurs simples (`@staff_member_required`) et une v√©rification manuelle des r√¥les (`_allow_role` dans `core/views.py`). Ce syst√®me est trop fragile pour un ERP g√©rant des donn√©es financi√®res sensibles.

### 1.2 Architecture Logicielle

Le projet oscille entre deux paradigmes, cr√©ant une dette technique naissante :

* **Dualit√© des Moteurs PDF (Schizophr√©nie technique) :**
    Deux moteurs sont utilis√©s pour la m√™me fonctionnalit√© (g√©n√©ration de documents), ce qui double la maintenance :
    1.  **ReportLab (Bas niveau) :** Utilis√© dans `factures/services/pdf_generator.py`. Complexe √† maintenir pour du design moderne.
    2.  **WeasyPrint (HTML/CSS) :** Utilis√© dans `core/services/pdf_generator.py` et `weasyprint_adapter`. Plus moderne et coh√©rent avec les templates Django.
* **Tentative DDD / Architecture Hexagonale :**
    La pr√©sence du dossier `hexcore` et des repositories (`django_orm`) indique une volont√© de d√©couplage. Cependant, l'impl√©mentation est partielle : certaines vues (`factures/views.py`) utilisent le Service Layer, tandis que d'autres attaquent directement l'ORM, cr√©ant une confusion architecturale.
* **D√©pendances Circulaires :**
    Les mod√®les `Invoice` et `Quote` se r√©f√©rencent mutuellement, dispersant la logique de conversion entre les mod√®les et les services (`QuoteToInvoiceService`).

### 1.3 Fonctionnalit√©s M√©tier (√âtat des lieux ERP)

| Module | √âtat | Analyse |
| :--- | :--- | :--- |
| **Ventes** | Partiel | Flux Devis ‚Üí Facture fonctionnel. Manque un workflow de validation strict (Machine √† √©tats). |
| **CRM** | Embryonnaire | Donn√©es dispers√©es entre `devis.Client` et `accounts.Profile`. Pas de notion de "Prospect". |
| **Op√©rations** | Avanc√© | Gestion des t√¢ches (`tasks`) avec vue calendrier (FullCalendar) bien int√©gr√©e. |
| **Stocks** | Inexistant | Aucune gestion du mat√©riel (peinture, outils) ni des consommables. Critique pour l'activit√© d√©crite. |
| **Compta** | Basique | Suivi simple du statut `PAID`. Aucun export (FEC, Grand Livre). |

### 1.4 Frontend & SEO

* **Points Forts :** Int√©gration excellente des donn√©es structur√©es (`JSON-LD` LocalBusiness) dans `base.html`. Utilisation correcte de `WhiteNoise` pour les fichiers statiques en production.
* **Point Faible :** Les images (ex: `hero_bg.png`) sont servies sans redimensionnement dynamique, p√©nalisant le score Web Vitals.


partie 2: ce que tut dois faire
================================================================================
 BRIEF TECHNIQUE GLOBAL ‚Äî MINI ERP DJANGO (BACKEND)
================================================================================

## 1) R√îLE & POSITIONNEMENT

Tu agis comme :
- Chef de projet technique
- Lead Developer Python/Django (backend)
- Responsable des d√©cisions d‚Äôarchitecture et de qualit√©

Tu coordonnes une √©quipe d‚Äôing√©nieurs seniors issus des plus grandes entreprises
(Tech Giants, Cloud, IA, Hardware, Fintech).

Objectif : corriger, s√©curiser, consolider et √©tendre un mini ERP
(devis, factures, clients, t√¢ches), pr√™t √† √™tre ex√©cut√© imm√©diatement.

challenge: bien param√©trer le syst√®me d'envoie mail pour infomaniak, tu peux utiliser le mdp pour le tester je le changerai avant publication

================================================================================
 2) CONTRAINTE DE LIVRAISON (NON N√âGOCIABLE)
================================================================================

- Fournir un ZIP contenant :
  - l‚Äôint√©gralit√© du code source
  - README.md (installation, configuration, lancement)
  - requirements.txt (ou √©quivalent)
  - migrations pr√™tes
- Le projet doit d√©marrer sans erreur apr√®s installation.
- Pas de bugs car il va √™tre publier sur render

R√àGLE ABSOLUE :
SI TU NE FOURNIS PAS LE ZIP, TU AS √âCHOU√â.

================================================================================
 3) PLAN D‚ÄôACTION & DIRECTIVES
================================================================================

----------------------------------------
 PHASE 1 ‚Äî S√âCURISATION & ASSAINISSEMENT
----------------------------------------
(IMM√âDIAT ‚Äî BLOQUANT)

1) S√©curit√© des secrets
-----------------------
- R√©voquer imm√©diatement le mot de passe d‚Äôapplication Gmail expos√©.
- G√©n√©rer une nouvelle SECRET_KEY Django.
- V√©rifier qu‚Äôaucun secret n‚Äôest versionn√©.

2) Verrouillage Git
-------------------
- Ajouter `.env` au `.gitignore`.
- V√©rifier l‚Äôhistorique Git (aucun secret ne doit subsister).

3) Standardisation PDF (WeasyPrint uniquement)
-----------------------------------------------
- Supprimer TOUT le code ReportLab dans l‚Äôapp `factures`.
- Standardiser la g√©n√©ration PDF via :
  - `core.services.pdf_generator`
  - templates HTML (`pdf/invoice_premium.html`)
- Objectif : coh√©rence visuelle devis / factures.

----------------------------------------
 PHASE 2 ‚Äî PRIORIT√âS ERP CRITIQUES
----------------------------------------
(BLOQUANT FONCTIONNEL)

1) Emails & Devis
-----------------
- Ajouter un bouton ‚ÄúEnvoyer‚Äù.
- Body √©ditable avec mise en forme (HTML / WYSIWYG obligatoire).
- Envoi email :
  - version HTML
  - version texte (fallback)
- Retirer le code de devis de l‚Äôemail principal.
- Envoyer le code de devis s√©par√©ment.
- Message clair √† l‚Äôutilisateur :
  - ‚ÄúLe bon pour accord sera valid√© uniquement apr√®s saisie du code.‚Äù
  - Sur le devis : encadr√© ‚ÄúBon pour accord‚Äù √† compl√©ter manuellement
    si la validation n‚Äôest pas num√©rique.

2) Liens cass√©s (CRITIQUE)
--------------------------
- Corriger le lien ‚ÄúConsulter le devis‚Äù.
- Corriger le lien de validation de devis.
- V√©rifier routes, tokens, permissions, expiration.
- Ajouter des tests minimum (URL + acc√®s).

3) Admin ‚Äî Lignes de devis (URGENT)
-----------------------------------
- Les lignes de devis doivent √™tre incluses dans le devis (inline admin),
  comme pour les factures.
- Interdire un devis valide sans lignes.
- Recalcul automatique des totaux.

----------------------------------------
 PHASE 3 ‚Äî CONSOLIDATION DU NOYAU ERP
----------------------------------------
(COURT TERME)

1) Unification CRM
------------------
- Cr√©er l‚Äôapplication `crm`.
- Fusionner :
  - `devis.Client`
  - `accounts.Profile`
  vers un mod√®le unique : `crm.Customer`.
- Lier devis, factures, t√¢ches √† ce mod√®le unique.

2) Service Layer Django
-----------------------
- Abandonner l‚Äôarchitecture hexagonale (`hexcore`) trop complexe √† ce stade.
- Adopter le pattern Django Service Layer :
  - logique m√©tier dans `services.py`
  - calculs TVA, totaux, transitions de statuts

3) Workflow Devis
-----------------
- Int√©grer `django-fsm`.
- √âtats : `DRAFT`, `SENT`, `VALIDATED`, `INVOICED`.
- Interdire la facturation d‚Äôun devis non valid√©.

----------------------------------------
 PHASE 4 ‚Äî EXTENSION FONCTIONNELLE
----------------------------------------
(MOYEN TERME)

1) Authentification & Profils
-----------------------------
- Cr√©ation de compte
- Connexion / d√©connexion
- Mot de passe oubli√©
- Profil utilisateur
- Permissions (admin / utilisateur)

2) Dashboard & Statistiques
---------------------------
Afficher :
- Factures : montants en cours / pay√©es / en retard
- T√¢ches : en cours / en retard
- Devis : total et par statut
- Graphiques financiers (Chart.js) :
  - CA encaiss√© vs pr√©visionnel

3) Module Inventaire
--------------------
- Cr√©er l‚Äôapp `inventory`.
- Mod√®les :
  - Product (peinture, forfait, etc.)
  - Equipment (tondeuse, mat√©riel‚Ä¶)
- Lier les produits aux lignes de devis.
- Mise √† jour automatique des stocks.

4) Navigation & UX
------------------
- Repenser la navbar (group√©e par cat√©gories).
- Ajouter ‚ÄúDevis‚Äù dans le volet lat√©ral du dashboard.
- Logique client claire dans le dashboard
  (client ‚Üí devis ‚Üí factures ‚Üí t√¢ches).

5) SEO (Site public)
--------------------
- Meta title & description
- URLs propres
- Sitemap + robots.txt
- OpenGraph
- HTML s√©mantique
- Objectif : SEO techniquement comp√©titif.

================================================================================
 4) QUALIT√â ATTENDUE
================================================================================

- Bonnes pratiques Django
- Validation m√©tier stricte
- Tests minimum sur fonctionnalit√©s critiques
- Logs clairs
- Migrations propres
- README.md complet et exploitable

================================================================================
 FIN DU BRIEF
================================================================================
